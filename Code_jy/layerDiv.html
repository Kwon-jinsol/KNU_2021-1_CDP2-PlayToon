<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/psd.js/2.0.0/psd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/psd.js/2.0.0/psd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/konva/7.2.5/konva.min.js"></script>

  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
  <title>PlayToon-Editor</title>
  <link rel="shortcut icon" type="image/x-icon" href="icons/icon.ico">
</head>

<style>
  body {
    /* width: 100vw; */
    background: #343434;
    -ms-overflow-style: none;
    /* IE and Edge */
    scrollbar-width: none;
    /* Firefox */
    margin: 0;
  }

  body::-webkit-scrollbar {
    display: none;
    /* Chrome, Safari, Opera*/
  }

  /* img {
    width: auto;
    height: auto;
    max-width: 400px;
    max-height: 400px;
  } */

  p {
    border: 1px solid red;
    width: 160px;
  }



  div {
    float: left;
  }

  .line {
    float: none;
    width: 100px;
    height: 30px;
    border: 1px solid gold;
  }

  .timeline {
    width: 500px;
    height: 200px;
    border: 1px solid blue;
    margin: 20px;
  }

  .widget-field {
    position: absolute;
    top: 63px;
    left: 1503px;
    width: 415px;
    height: 587px;
    /* background-color:burlywood; */
    border-bottom: 3px solid #535353;
    overflow-y: scroll;
  }

  .widget-title {
    position: fixed;
    padding-left: 10px;
    width: 100%;
    background-color: #b8b8b8;
    font-weight: bold;
    z-index: 100;
  }

  .widget {
    position: relative;
    margin: 20px;
    /* top: 20px;
    left: 20px; */
    width: 370px;
    height: 230px;
    background-color: #85827a;
  }

  .temp {
    position: relative;
    /* top: 200px;
    left: 200px; */
    width: 2000px;
    height: 1200px;
  }

  .img-field{
    width: 1500px;
    height: 587px;
    /* background-color: pink; */
    border-right: 3px solid #535353;
    border-bottom: 3px solid #535353;
    overflow: scroll;
    /* resize: none; */
  }

  .img-title {
    text-align: center;
    /* display: table; */
    background-color: #ffffff;
    border: 3px solid #cecece;
    width: 1300px;
    /* height: 250px; */
    position: relative;
    top: 20px;
    left: 60px;
  }

  .img-panel {
    width: 100%;
    /* height: 25px; */
    background-color: #b8b8b8;
    text-align: center;
    font-weight: bold;
  }

  .img-div {
    /* display: table-cell; */
    vertical-align: middle;
  }

  .ImgCon {
    width: auto;
    height: auto;
    max-width: 200px;
    max-height: 200px;
    background-size: cover;
    border: 1px solid black;
    /* resize: both;
    overflow: scroll; */
  }

  .dropzone {
    position: absolute;
    top: 650.667px;
    left: 0px;
    width: 300px;
    height: 325.333px;
    background-color: #343434;
    color: #d6d6d6;
    /* margin: 20px; */
    border-top: 1px solid #d6d6d6;
    border-right: 1px solid #d6d6d6;
    overflow-y: scroll;
    z-index: -1;
  }

  strong {
    padding: 10px;
    position: relative;
    top: 5px;
  }

  hr {
    position: relative;
    top: 3.8px;
    background-color: #535353;
    height: 1px;
    border: 0;
    margin: 0px;
  }

  /* 스크롤바 설정*/
  .type2::-webkit-scrollbar {
    width: 6px;
  }

  /* 스크롤바 막대 설정*/
  .type2::-webkit-scrollbar-thumb {
    height: 17%;
    background-color: rgb(117, 117, 117);
    border-radius: 10px;
  }

  /* 스크롤바 뒷 배경 설정*/
  .type2::-webkit-scrollbar-track {
    background-color: rgba(19, 19, 19, 0.33);
  }


  .directory-list {
    padding: 10px;
    /* padding-top: 20px; */
    margin: 0px

  }

  .directory-list ul {
    margin-left: 10px;
    padding-left: 20px;
    border-left: 1px dashed #ddd;
  }

  .directory-list li {
    list-style: none;
    color: #888;
    font-size: 17px;
    font-style: italic;
    font-weight: normal;
  }

  li .file {
    border: 1px solid #343434;
    /* width: 260px; */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .directory-list a {
    width: 360px;
    border-bottom: 1px solid transparent;
    color: #888;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .directory-list a:hover {
    border-color: #eee;
    color: #000;
  }

  .directory-list .folder,
  .directory-list .folder>a {
    color: #777;
    font-weight: bold;
  }

  .fileInfo {
    opacity: 0;
    position: absolute;
    top: 730px;
    left: 300px;
    width: 250px;
    height: 220px;
    border: cornsilk 1px solid;
  }

  /* The icons
-------------------------------------------------------------- */

  .directory-list li:before {
    margin-right: 10px;
    content: "";
    height: 20px;
    vertical-align: middle;
    width: 20px;
    background-repeat: no-repeat;
    display: inline-block;
    /* file icon by default */
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='lightgrey' d='M85.714,42.857V87.5c0,1.487-0.521,2.752-1.562,3.794c-1.042,1.041-2.308,1.562-3.795,1.562H19.643 c-1.488,0-2.753-0.521-3.794-1.562c-1.042-1.042-1.562-2.307-1.562-3.794v-75c0-1.487,0.521-2.752,1.562-3.794 c1.041-1.041,2.306-1.562,3.794-1.562H50V37.5c0,1.488,0.521,2.753,1.562,3.795s2.307,1.562,3.795,1.562H85.714z M85.546,35.714 H57.143V7.311c3.05,0.558,5.505,1.767,7.366,3.627l17.41,17.411C83.78,30.209,84.989,32.665,85.546,35.714z' /></svg>");
    background-position: center 2px;
    background-size: 60% auto;
  }

  .directory-list li.folder:before {
    /* folder icon if folder class is specified */
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='lightblue' d='M96.429,37.5v39.286c0,3.423-1.228,6.361-3.684,8.817c-2.455,2.455-5.395,3.683-8.816,3.683H16.071 c-3.423,0-6.362-1.228-8.817-3.683c-2.456-2.456-3.683-5.395-3.683-8.817V23.214c0-3.422,1.228-6.362,3.683-8.817 c2.455-2.456,5.394-3.683,8.817-3.683h17.857c3.422,0,6.362,1.228,8.817,3.683c2.455,2.455,3.683,5.395,3.683,8.817V25h37.5 c3.422,0,6.361,1.228,8.816,3.683C95.201,31.138,96.429,34.078,96.429,37.5z' /></svg>");
    background-position: center top;
    background-size: 75% auto;
  }

  /* nav */
  .nav {
    background-color: #cecece;
    width: 100%;
    height: 60px;
    border-bottom: 3px solid #535353;
  }

  .nav_item {
    /* background-color: rgb(252, 126, 126); */
    /* color: white; */
    width: 50px;
    height: 100%;
    font-size: 10px;
    text-align: center;
    /* margin-left: 15px; */
  }

  .nav_item:hover {
    background-color: rgb(167, 167, 167);
  }

  .gap {
    height: 100%;
    width: 20px;
  }

  img {
    z-index: 999;
    width: 40px;
    margin-top: 3px;
    /* -webkit-filter: opacity(.5) drop-shadow(0 0 0 gray); */
    /* filter: opacity(.5) drop-shadow(0 0 0 white); */
    /* filter: hue-rotate(100deg); */
  }

</style>

<body>
  <div class="nav">
    <div class="gap"></div>
    <div class="nav_item new_project">
      <img src="icons/030-note.png" alt="">
      새 프로젝트
    </div>
    <div class="gap"></div>
    <div class="nav_item load_project">
      <img src="icons/019-folder.png" alt="">
      불러오기
    </div>
    <div class="gap"></div>
    <div class="nav_item save">
      <img src="icons/020-floppy disk.png" alt="">
      저장하기
    </div>
    <div class="gap"></div>
    <div class="nav_item import">
      <img src="icons/import.png" alt="">
      가져오기
    </div>
    <div class="gap"></div>
    <div class="nav_item export">
      <img src="icons/export.png" alt="">
      내보내기
    </div>
    <div class="gap"></div>
    <div class="nav_item cloud">
      <img src="icons/cloud.png" alt="">
      클라우드
    </div>
    <div class="gap"></div>
    <div class="nav_item move">
      <img src="icons/pointer.png" alt="">
      이동
    </div>
    <div class="gap"></div>
    <div class="nav_item rotate">
      <img src="icons/refresh.png" alt="">
      회전
    </div>

    <div class="gap"></div>
    <div class="nav_item size">
      <img src="icons/013-control.png" alt="">
      크기조절
    </div>
    <div class="gap"></div>
    <div class="nav_item hand">
      <img src="icons/hello.png" alt="">
      손바닥
    </div>
    <div class="gap"></div>
    <div class="nav_item zoom">
      <img src="icons/search.png" alt="">
      돋보기
    </div>
    <div class="gap"></div>
    <div class="nav_item cut-scene">
      <img src="icons/comic-book.png" alt="">
      컷나누기
    </div>
    <div class="gap"></div>
    <div class="nav_item speech-bubble">
      <img src="icons/conversation.png" alt="">
      말풍선
    </div>
    <div class="gap"></div>
    <div class="nav_item load">
      <img src="icons/text-box.png" alt="">
      텍스트
    </div>
    <!-- 
      <img src="icons/" alt=""> 
    -->
    <div class="gap"></div>
    <div class="nav_item effect">
      <img src="icons/star.png" alt=""> 
      효과
    </div>
    <div class="gap"></div>
    <div class="nav_item change">
      <img src="icons/picture-1.png" alt=""> 
      화면전환
    </div>
    <div class="gap"></div>
    <div class="nav_item sound">
      <img src="icons/speaker-1.png" alt=""> 
      사운드
    </div>
    <div class="gap"></div>
    <div class="nav_item undo">
      <img src="icons/undo.png" alt=""> 
      실행취소
    </div>
    <div class="gap"></div>
    <div class="nav_item redo">
      <img src="icons/redo.png" alt=""> 
      재개
    </div>
  </div>
  <div class="dropzone type2" ondrop="file_drop_handler(event)" ondragover="dragover_handler(event)">
    <strong>File list</strong>
    <hr>
    <ul class="directory-list">
    </ul>
  </div>
  <div class="fileInfo" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"><strong>fileInfo</strong>
  </div>
  <!-- <div class="timeline"><strong>timeline</strong></div> -->

  <div class="img-field type2">
    <div class="img-title">
      <!-- <strong>img-title</strong> -->
      <div class="img-panel">
        Image Panel
      </div>
      <div class="img-div" id="img-div">
        <!--<div class="ImgCon" id="ImageContainer"></div>-->
      </div>
    </div>
    <div class="temp"></div>
  </div>

  <div class="widget-field type2">
    <div class="widget-title">Widget Field</div>
    <div class="widget"></div>
    <div class="widget"></div>
    <div class="widget"></div>
  </div>

  

  <!-- timeline -->
  <script type="module">
    import { Timeliner } from './src/timeliner.js'
    var target = {
      x: 0,
      y: 0,
      rotate: 0
    };
    var timeliner = new Timeliner(target);

    function add_layer(name) {
      timeliner.addLayer(name);
    }

    let page = document.querySelector('.fileInfo');

    let observer = new MutationObserver((mutations) => {
      // alert('test');
      let test1 = page.children;
      let count1 = test1.length;
      let layer_name = test1[count1 - 1].textContent;
      timeliner.addLayer(layer_name);
      // timeliner.repaintAll();
    })
    // timeliner.addLayer('layer1');
    let options = {
      attributes: true,
      childList: true,
      characterData: true
    };

    observer.observe(page, options);
  </script>

  <!-- -->
  <script>
    var Info = document.querySelector(".fileInfo");
    var Timeline = document.querySelector(".timeline");
    var ImgDiv = document.querySelector(".img-div");
    var dropZone = document.querySelector(".dropzone");
    var directory = document.querySelector(".directory-list");
    var PSD = require('psd');
    var psd_data = [];
    var layer_number = [];

    function dragover_handler(ev) {
      ev.preventDefault();
      // dropEffect를 move로 설정.
      ev.dataTransfer.dropEffect = "move";
    }

    // Load from event, e.g. drag & drop
    function drop_handler(ev) {
      ev.preventDefault();
      //id == layer number of psd_data[]
      var id = ev.dataTransfer.getData("text");
      console.log(id);
      //ev.target.appendChild(document.getElementsById('data'));

      // PSD.fromEvent(ev).then(function (psd) {
      // node = psd.tree().descendants();
      //psd.layers[1].image.toPng('./output.png');

      Info.innerHTML += "<p>" + psd_data[id].name + "</p>";
      // Timeline.innerHTML += "<div class='line''>" + "</div>";
      //        ImgDiv.innerHTML += "<div class='ImgCon' id= 'ImageContainer" + id + "'>" + "</div>";

      var imageObj = new Image();
      var layerimg = psd_data[id].toPng();
      imageObj.src = layerimg.src;
      imageObj.onload = function () {
        drawImage(this);
      };

      //document.getElementById('ImageContainer'+id).appendChild(psd_data[id].toPng());  

      /*      
              var imgcon = document.createElement('div');
              imgcon.id = 'ImageContainer';
              imgcon.className = 'ImgCon';
        */

      //show psd file
      /*
      imgcon.appendChild(png);
      ImgDiv.appendChild(imgcon);
      */

      //});

    }

    var count_folder = 0;
    var count_group = 0;
    var count_layer = 0;
    var file_length = 0;

    function createFolder(files) {
      var dirHTML = "";
      for (let i = 0; i < files.length; i++) {
        dirHTML +=
          "<li id='numFolder" + count_folder + "' class='folder' onclick = 'folder_click(event)'>"
          //  + "<i id='folder' class='glyphicon glyphicon-folder-close'></i>"
          + files[i].name
          + "<ul id='numList" + count_folder + "' class='list'>"
          + "</ul>"
          + "</li>";
      }
      directory.innerHTML += dirHTML;
    }

    function createList(node) {
      //psd file has Group
      console.log(node);
      if (node[0].get('type') == 'group') {
        for (let i = 0; i < node.length; i++) {
          psd_data.push(node[i]);
          if (node[i].get('type') == 'group') {
            count_group += 1;
            var groupId = 'group' + count_group;
            var ulHTML = "<ul id='" + groupId + "'></ul>";
            var id = "#numList" + count_folder;
            $(id).append("<li class='folder' onclick = 'folder_click(event)'>"
              + psd_data[i].name
              + ulHTML
              + "</li>");
          }
          else {
            var id = "#group" + count_group;
            var layerNum = i + file_length;
            $(id).append("<li draggable='true' id='" + layerNum + "' class='file' ondragstart='drag_start(event)' onclick = 'folder_click(event)'>"
              + node[i].name
              + "</li>");
            layer_number.push(layerNum);
          }
        }
      }//psd file has no Group
      else {
        count_group += 1;
        var groupId = 'group' + count_group;
        var ulHTML = "<ul id='" + groupId + "'></ul>";
        var id = "#numList" + count_folder;
        $(id).append("<li class='folder' onclick = 'folder_click(event)'>"
          + "noGroup"
          + ulHTML
          + "</li>");
        for (let i = 0; i < node.length; i++) {
          psd_data.push(node[i]);
          var id = "#group" + count_group;
          var layerNum = i + file_length;
          $(id).append("<li draggable='true' id='" + layerNum + "' class='file' ondragstart='drag_start(event)' onclick = 'folder_click(event)'>" + node[i].name + "</li>");
          layer_number.push(layerNum);
        }
      }
      count_folder += 1;
      folder_effect();
      file_length = psd_data.length;

      //imageObj.src = './folder1.png';

      console.log(psd_data[0].get('type'));
    }


    function file_drop_handler(ev) {
      ev.preventDefault();
      var dt = ev.dataTransfer;
      var files = dt.files;

      createFolder(files);

      PSD.fromEvent(ev).then(function (psd) {
        node = psd.tree().descendants();
        png = psd.image.toPng();
        console.log(psd);
        //console.log(node[1].get('layerId'));
        console.log(psd.tree().export());
        if (psd.tree().hasChildren())
          createList(node);
      });



    }

    function drag_start(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
      ev.target.style.color = 'gold';
      console.log(ev.target.id);
    }

    function folder_effect() {
      // get all folders in our .directory-list

      //folder open-close
      var allFolders = $(".directory-list li > ul");
      allFolders.each(function () {
        // add the folder class to the parent <li>
        var folderAndName = $(this).parent();
        //folderAndName.addClass("folder");

        // backup this inner <ul>
        var backupOfThisFolder = $(this);
        // then delete it
        $(this).remove();
        // add an <a> tag to whats left ie. the folder name
        folderAndName.wrapInner("<a href='#' />");
        // then put the inner <ul> back
        folderAndName.append(backupOfThisFolder);

        // now add a slideToggle to the <a> we just added
        folderAndName.find("a").click(function (e) {
          $(this).siblings("ul").slideToggle("slow");
          e.preventDefault();
        });

      });
    }

    function folder_click(ev) {
      console.log(ev.target.id);
      //ev.find('i').toggleClass('glyphicon glyphicon-folder-open');
      var data = document.getElementById('data');
      //  data.classList.toggle('glyphicon glyphicon-folder-open');
      //  data.firstChild.classList.toggle('glyphicon glyphicon-folder-open');
      //.classList.remove('glyphicon glyphicon-folder-close');

      //dropZone.firstChild.toggleClass('glyphicon glyphicon-folder-open');

    }
  </script>


  <!--konva.js for canvas control-->
  <script>
    var width = window.innerWidth - 600;
    var height = window.innerHeight - 450;
    var s = null;

    var stage = new Konva.Stage({
      container: 'img-div',
      width: 1300,
      height: 500,
    });

    var layer = new Konva.Layer();
    stage.add(layer);

      
    var tr = new Konva.Transformer({
      centeredScaling: true,
      name: 'transformer',
    });

    tr.rotationSnaps([0, 90, 180, 270]);
    tr.keepRatio(false);
    layer.add(tr);
        
    function drawImage(imageObj) {
      // img
      var Img = new Konva.Image({
        image: imageObj,
        x: stage.width() / 2 - 200 / 2,
        y: stage.height() / 2 - 137 / 2,
        width: 200,
        height: 100,
        stroke: 'black',
        name: 'image',
        strokeWidth: 1,
        draggable: true,
      });

      // add cursor styling
      Img.on('mouseover', function () {
        document.body.style.cursor = 'pointer';
      });
      Img.on('mouseout', function () {
        document.body.style.cursor = 'default';
      });
      
      layer.add(Img);
      tr.nodes([Img]);
      tr.moveToTop();
      s = Img;
    }
    
      // add a new feature, lets add ability to draw selection rectangle
      
      var selectionRectangle = new Konva.Rect({
          fill: 'rgba(0,0,255,0.5)',
          visible: false
      });
      layer.add(selectionRectangle);

      var x1, y1, x2, y2;
      stage.on('mousedown touchstart', (e) => {
        // do nothing if we mousedown on any shape
        if (e.target != stage) {
          return;
        }
        x1 = stage.getPointerPosition().x;
        y1 = stage.getPointerPosition().y;
        x2 = stage.getPointerPosition().x;
        y2 = stage.getPointerPosition().y;

        selectionRectangle.visible(true);
        selectionRectangle.width(0);
        selectionRectangle.height(0);
      });

      stage.on('mousemove touchmove', () => {
        // no nothing if we didn't start selection
        if (!selectionRectangle.visible()) {
          return;
        }
        x2 = stage.getPointerPosition().x;
        y2 = stage.getPointerPosition().y;

        selectionRectangle.setAttrs({
          x: Math.min(x1, x2),
          y: Math.min(y1, y2),
          width: Math.abs(x2 - x1),
          height: Math.abs(y2 - y1),
        });
      });

      stage.on('mouseup touchend', (e) => {
        // no nothing if we didn't start selection
        if (!selectionRectangle.visible()) {
          return;
        }

        // update visibility in timeout, so we can check it in click event
        setTimeout(() => {
          selectionRectangle.visible(false);
        });

        var shapes = stage.find('.image');
        var box = selectionRectangle.getClientRect();
        var selected = shapes.filter((shape) =>
          Konva.Util.haveIntersection(box, shape.getClientRect())
        );
        tr.nodes(selected);
      });

      // clicks should select/deselect shapes
      stage.on('click tap', function (e) {
        // if we are selecting with rect, do nothing
        if (selectionRectangle.visible()) {
          return;
        }

        // if click on empty area - remove all selections
        if (e.target === stage) {
          tr.nodes([]);
          return;
        }

        // do nothing if clicked NOT on our image
        if (!e.target.hasName('image')) {
          return;
        }
        
        // do we pressed shift or ctrl?
        const metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.metaKey;
        const isSelected = tr.nodes().indexOf(e.target) >= 0;
        s = e.target;
        if (!metaPressed && !isSelected) {
          // if no key pressed and the node is not selected
          // select just one
          tr.nodes([e.target]);
        } else if (metaPressed && isSelected) {
          // if we pressed keys and node was selected
          // we need to remove it from selection:
          const nodes = tr.nodes().slice(); // use slice to have new copy of array
          // remove node from array
          nodes.splice(nodes.indexOf(e.target), 1);
          tr.nodes(nodes);
        } else if (metaPressed && !isSelected) {
          // add the node into selection
          const nodes = tr.nodes().concat([e.target]);
          tr.nodes(nodes);
        }
      });

      document.getElementById('moveup').addEventListener('click', function() {
        console.log(s);
        s.moveUp();
        console.log(s.zIndex());
        return;
      });

      document.getElementById('movedown').addEventListener('click', function() {
        s.moveDown();
        console.log(s.zIndex());
        return;
      });
  </script>
</body>